module.exports=function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";var r=(n(1),n(12));e.exports={handleUserFacebookTokenChange_v2:r.handleUserFacebookTokenChange,handleUserInfoChange_v2:r.handleUserInfoChange,handleUserVerifications_v2:r.handleUserVerifications,handleOcean_v2:r.ocean.ocean,handlePools_v2:r.ocean.poolStatus}},function(e,t){e.exports=require("firebase-functions")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("firebase")},function(e,t){e.exports=require("geofire")},function(e,t){e.exports=require("moment")},function(e,t,n){"use strict";var r=n(1),i=n(2),a=n(5);e.exports=r.database().path("/users/tokens/{uid}").onWrite(function(e){var t=e.data;if(t.previous.child("facebook").val()===t.child("facebook").val())return Promise.resolve();if(!t.child("facebook").val())return Promise.resolve();var n=e.params.uid,r=t.adminRef.root,o=["id","name","birthday","gender","age_range","first_name","last_name"].join(",");return i({method:"get",url:"https://graph.facebook.com/v2.7/me?access_token="+t.child("facebook").val()+"&fields="+o}).then(function(e){return e.data}).then(function(e){var t=e.id,o=e.name,s=e.gender,u=e.age_range,c=void 0===u?{}:u,l=e.first_name,d=e.last_name,f=e.birthday,h={fid:t,name:o,gender:s||null,first_name:l,last_name:d,age_range_on_facebook_min:c.min||null,age_range_on_facebook_max:c.max||null};f&&(f=3!==f.split("/").length?null:a(f,"MM/DD/YYYY").format("YYYY-MM-DD"));var v=r.child("/users/info/"+n);return v.once("value").then(function(e){return e.val()}).then(function(e){return(!e||!e.birthday&&f)&&(h.birthday=f),v.update(h).then(function(){return i.get("https://graph.facebook.com/v2.7/"+h.fid+"/picture?type=large&redirect=0").then(function(e){return e.data.data.url}).then(function(e){return r.child("/users/info/"+n+"/avatar").set(e)})}).then(function(){if(e)return Promise.resolve();var t=r.child("/users/settings/"+n);return t.once("value").then(function(e){return e.val()}).then(function(e){return e||(e={}),t.set(Object.assign({suspend_discovery:!1,notify_new_messages:!0,notify_announcements:!1,gender:"both",age_min:18,age_max:45,only_from_network:!1},e))})})})}).catch(function(e){return console.log("Error in tokens",t.val(),e),t.ref.set(null)})})},function(e,t,n){"use strict";var r=n(5);e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.network,n=void 0===t?null:t,i=e.gender,a=void 0===i?null:i,o=e.birthday,s=void 0===o?null:o,u=e.first_name,c=void 0===u?null:u,l=e.last_name,d=void 0===l?null:l,f=e.avatar,h=void 0===f?null:f,v=e.current_question,m=void 0===v?null:v,p=e.current_question_id,_=void 0===p?null:p,b={};return n&&(b.network=n),a&&(b.gender=a),h&&(b.avatar=h),m&&(b.current_question=m),_&&(b.current_question_id=_),s&&(b.age=r().diff(r(s,"YYYY-MM-DD"),"years")),c&&d&&(b.display_name=c+" "+d.charAt(0)+"."),b}},function(e,t,n){"use strict";var r=n(2),i=function(e){return!0};e.exports=function(e,t,n){return n.child("/users/info/"+e+"/mobile_number_verified").set(!1).then(function(){if(!i(t))return n.child("/users/info/"+e+"/mobile_number").set(null);var a=Math.floor(9e5*Math.random())+1e5,o=n.child("/users/verifications/mobile_number/"+e);return o.child("_code").set(a).then(function(){return r({method:"post",url:"https://api.bulutfon.com/messages",data:{receivers:t,title:"BARBAR",content:"Use "+a+" to verify your number.",access_token:"a110f6e2e5528ab87352ea4daa671cf41ab0cbb1eb32d4f96b1f42bc64ff8cae"}}).then(function(){return o.child("status").set("SENT_SMS")}).catch(function(e){return console.log("There was an error with the mobile number verification",e),o.child("status").set("FAILED_SMS")})})})}},function(e,t,n){"use strict";var r=n(2),i=n(15),a=n(16),o=n(17),s=function(e){return e.split("@")[1].replace(/\./g,"-")};e.exports=function(e,t,n,u){var c=u.child("/users/info/"+e+"/fid").once("value").then(function(e){return e.val()});return c.then(function(c){if(0===c)return Promise.resolve();var l=u.child("/users/info/"+e+"/network_email_verified");return l.set(!1).then(function(){var c=u.child("/users/info/"+e),l=u.child("/users/verifications/network_email/"+e);if(null===t)return l.set(null).then(function(){return c.child("network").set(null).then(function(){return u.child("/settings/networks/email-map/"+s(n)).once("value").then(function(e){return e.val()}).then(function(t){return u.child("/users/network-map/"+t+"/"+e).set(null)})})});var d=c.child("network_email");if(!o.isEmail(t))return d.set(null);var f=o.normalizeEmail(t);if(t!==f)return d.set(f);var h=u.child("/code-generation").push().key;return l.child("_code").set(h).then(function(){var n=i.encode({code:h,uid:e},"PROCO"),o="https://procoapp.com/a/verifications?token="+n;return r.post("https://api:key-c31f9f2fec6c5f5d99e19868314c0323@api.mailgun.net/v3/icoz.co/messages",a.stringify({from:"Proco Verification <verifications@icoz.co>",to:t,subject:"Verify your university - Proco",text:"Go to "+o+" to verify your university e-mail.",html:'Click <a href="'+o+'">here</a> to verify your university e-mail.'})).then(function(){return l.child("status").set("SENT_EMAIL").then(function(){return u.child("/settings/networks/email-map/"+s(t)).once("value").then(function(e){return e.val()}).then(function(t){return t?c.child("network").set(t).then(function(){return u.child("/users/network-map/"+t+"/"+e).set(!0)}):(console.log("WARNING","This user is malicious",e),d.set(null))})})}).catch(function(e){return console.log("There was an error with the network e-mail verification",e),l.child("status").set("FAILED_EMAIL")})})})})}},function(e,t,n){"use strict";var r=n(1),i=n(7),a=n(9),o=n(8),s=function(e){return e.some(function(e){return Boolean(e)===!0})};e.exports=r.database().path("/users/info/{uid}").onWrite(function(e){var t=e.data,n=e.params.uid;if(null===t.val())return Promise.resolve();var r=t.previous,u=t.adminRef.root,c=[],l=function(e){return r.child(e).val()!==t.child(e).val()};if(l("network_email")&&c.push(a(n,t.child("network_email").val(),r.child("network_email"),u)),l("mobile_number")&&c.push(o(n,t.child("mobile_number").val(),u)),s([l("network"),l("birthday"),l("gender")])){var d=!!(t.child("network_email").val()&&t.child("network_email_verified").val()&&t.child("birthday").val()&&t.child("gender").val());c.push(u.child("/users/info/"+n+"/onboarded").set(d))}return s([l("network"),l("birthday"),l("gender"),l("first_name"),l("last_name"),l("avatar"),l("current_question"),l("current_question_id")])&&c.push(u.child("/users/profile/"+n).set(i(t.val()))),Promise.all(c)})},function(e,t,n){"use strict";var r=n(1);e.exports=r.database().path("/users/verifications/{verification_type}/{uid}").onWrite(function(e){var t=e.params,n=t.verification_type,r=t.uid,i=e.data,a=i.adminRef;return i.child("code").val()&&i.previous.child("code").val()!==i.child("code").val()?i.child("code").val()===i.child("_code").val()?a.root.child("/users/info/"+r+"/"+n+"_verified").set(!0).then(function(){return a.set(null)}):a.update({code:null,status:"WRONG_CODE"}):Promise.resolve()})},function(e,t,n){"use strict";var r=n(6),i=n(10),a=n(11),o=n(14);e.exports={handleUserFacebookTokenChange:r,handleUserInfoChange:i,handleUserVerifications:a,ocean:o}},function(e,t,n){"use strict";var r=n(3),i=n(4),a=r.database.ServerValue.TIMESTAMP;e.exports=function(e){var t=e.params.uid,n=e.data.adminRef.root.child("ocean"),r=n.child("statuses/"+t),o=n.child("index"),s=e.data.ref.parent.parent.child("pools/"+t),u=e.data.val().location;if(!u)return r.update({status:"NO_LOCATION",last_checked:a});var c=[u[0],u[1]],l=new i(o);return new Promise(function(e,n){var i=l.query({center:c,radius:500}),o=[];i.on("ready",function(){o.length>0&&r.update({status:"COMPLETED",last_checked:a});var t=i.radius();o.length<10&&t<5?i.updateCriteria({radius:t+1}):(i.cancel(),Promise.all(o).then(function(){r.update({status:"COMPLETED",last_checked:a}).then(function(){return e()})}).catch(function(e){console.log("Catched something",e),r.update({status:"FAILED",last_checked:a}).then(function(){return n(e)})}))}),i.on("key_entered",function(e,n,r){e!==t&&o.push(s.child(e).set({added_on:a,is_close:r<.3}).catch(function(){return Promise.resolve()}))})})}},function(e,t,n){"use strict";var r=n(1),i=n(13),a=n(4),o=n(3),s=o.database.ServerValue.TIMESTAMP,u={};u.ocean=r.database().path("/ocean/index/{uid}").onWrite(function(e){var t=e.data.child("l").val();if(!t)return e.data.adminRef.root.child("ocean/statuses/"+e.params.uid).update({status:"NO_LOCATION",last_checked:s});var n=e.data.previous.child("l").val();if(n){var r=a.distance([t[0],t[1]],[n[0],n[1]]);if(r<.5)return Promise.resolve()}return e.data.adminRef.root.child("ocean/statuses/"+e.params.uid).update({status:"NEEDS_REFRESH",last_checked:s,location:t})}),u.poolStatus=r.database().path("/ocean/statuses/{uid}").onWrite(function(e){var t=e.data.val();if(null===t)return Promise.resolve();var n=e.data.previous.val();return n&&n.status===t.status?Promise.resolve():"IN_PROGRESS_RESET"===t.status?e.data.adminRef.root.child("ocean/pools/"+e.params.uid).set(null).then(function(){return i(e)}):i(e)}),e.exports=u},function(e,t){e.exports=require("jwt-simple")},function(e,t){e.exports=require("qs")},function(e,t){e.exports=require("validator")}]);